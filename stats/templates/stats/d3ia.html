{% load static %}
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>D3AI</title>
    <style>
    text {
    font-size: 10px;
    text-anchor: middle;
    fill: #4f442b;
    }
    g > text.active {
    font-size: 30px;
    }
    circle {
    fill: #75739F;
    stroke: black;
    stroke-width: 1px;
    }
    circle.active {
    fill: #FE9922;
    }
    circle.inactive {
    fill: #C4B9AC;
    }
</style>
</head>
<body onload="createSoccerViz()">
    <div id="viz">
        <svg style="width: 500px; height: 500px; border: 1px solid lightgray;"></svg>
        <div id="controls"></div>
    </div>
</body>
<script src="{% static 'stats/js/d3.min.js' %}"></script>
<script>
function createSoccerViz() {
d3.csv("/static/stats/js/wc.csv").then((data) => overallTeamViz(data))
    function overallTeamViz(incomingData) {
        d3.select("svg")
        .append("g")
        .attr("id", "teamsG")
        .attr("transform", "translate(50,250)")
        .selectAll("g")
        .data(incomingData)
        .enter()
        .append("g")
        .attr("class", "overallG")
        .attr("transform", (d, i) =>"translate(" + (i * 50) + ", 0)")
        var teamG = d3.selectAll("g.overallG");
        teamG
        .append("circle")
        .attr("r", 20)
        teamG
        .append("text")
        .attr("y", 30)
        .text(d => d.team)

        teamG.on("mouseover", function (e,d, i) {highlightRegion(d, this)});
        function highlightRegion(d, _this) {
        const teamColor = d3.rgb("#75739F")
        d3.selectAll("g.overallG")
        .select("circle")
        .style("fill", p => p.region === d.region ? teamColor.darker(0.75) : teamColor.brighter(0.5))
    }

        const handleMouseOut = () => {
            teamG.select("circle").classed("inactive", false).classed("active", false)
        }
        teamG.on("mouseout", handleMouseOut)

        const dataKeys = Object.keys(incomingData[0]).filter(x => x !== "team" && x!== "region")
        d3.select("#controls").selectAll("button.teams").data(dataKeys).enter().append("button")
        .text(d=>d).on("click", (e, d) => handleBtnClick(d))// 
        function handleBtnClick(datapoint) {
            const maxValue = d3.max(incomingData, d => parseFloat(d[datapoint])) // Retourne le max de la colone selectionÃ©e
            const radiusScale = d3.scaleLinear().domain([0, maxValue]).range([2, 20])
            // const colorScale = d3.scaleLinear().domain([0, maxValue]).range(["green", "red"]).interpolate(d3.interpolateLab) // or d3.interpolateHsl or d3.interpolateHcl to interpolate intermediate value between color ramp
            // To use built-in d3 color ramp e use d3.scaleOrdinal() (d3.schemeCategory10, d3.schemeCategory20, d3.schemeCategory20b, and d3.schemeCategory20c)
            const colorSc = d3.scaleOrdinal().domain(["UEFA", "CONMEBOL", "CAF", "AFC"]).range(d3.schemeCategory10).unknown("#c4b9ac")
            d3.selectAll("g.overallG").select("circle").transition().duration(800).delay((d, i) => 50*i).attr("r", d => radiusScale(parseFloat(d[datapoint]))).style("fill", p => colorSc(p.region))
        }

    }
}
</script>
</html>